#include "mbed.h"

BufferedSerial pc(USBTX, USBRX, 9600); // パソコンとのシリアル通信
// int16_t M_1 = 8000, M_2 = 8000, M_3 = 8000, M_4 = 8000;
CAN can{PB_12, PB_13, (int)1e6}; // 12と13に送る
int16_t pwm[4] = {8000, 8000, 8000, 8000}; // pwm制御
CANMessage msg;

int main()
{
while (1)
{
if (pc.readable())
{
char buf;
pc.read(&buf, sizeof(buf));
if (buf == 'W' || buf == 'w')
{
pwm[0] = 8000; // 右
pwm[1] = 8000; // 右
pwm[2] = 8000; // 左
pwm[3] = 8000; // 左
osDelay(10); // 約10msecの待機
}
if (buf == 'Q' || buf == 'q')
{
pwm[0] = 2000; // 右
pwm[1] = 2000; // 右
pwm[2] = 2000; // 左
pwm[3] = 2000; // 左
osDelay(10); // 約10msecの待機
}
if (buf == 'V' || buf == 'v')
{
pwm[0] = 12000; // 右
pwm[1] = 12000; // 右
pwm[2] = 12000; // 左
pwm[3] = 12000; // 左
osDelay(10); // 約10msecの待機
}
if (buf == 'A' || buf == 'a')
{
pwm[0] = 2000;
pwm[1] = 2000;
pwm[2] = -2000;
pwm[3] = -2000;
osDelay(10); // 約10msecの待機
}
if (buf == 'S' || buf == 's')
{
pwm[0] = -8000;
pwm[1] = -8000;
pwm[2] = -8000;
pwm[3] = -8000;
osDelay(10); // 約10msecの待機
}
if (buf == 'E' || buf == 'e')
{
pwm[0] = -2000; // 右
pwm[1] = -2000; // 右
pwm[2] = -2000; // 左
pwm[3] = -2000; // 左
osDelay(10); // 約10msecの待機
}
if (buf == 'D' || buf == 'd')
{
pwm[0] = -2000;
pwm[1] = -2000;
pwm[2] = 2000;
pwm[3] = 2000;
osDelay(10); // 約10msecの待機
}
else
{
pwm[0] = 0;
pwm[1] = 0;
pwm[2] = 0;
pwm[3] = 0;
osDelay(10); // 約10msecの待機
}
CANMessage msg(5, reinterpret_cast<uint8_t *>(pwm), 8);
can.write(msg);
}
}
}

